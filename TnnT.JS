WidgetMetadata = {
  id: "tmdb.resource.module.hakuna",
  title: "TMDBèµ„æºæ¨¡å—",
  description: "è¶‹åŠ¿ã€çƒ­æ¦œã€å¹³å°ä¸€ç«™å¼èµ„æº",
  author: "Hakuna Matata",
  version: "0.0.1",
  requiredVersion: "0.0.2",
  detailCacheDuration: 60,
  modules: [
    {
      title: "TMDB ä»Šæ—¥è¶‹åŠ¿",
      description: "ä»Šæ—¥å…¨éƒ¨è¶‹åŠ¿",
      requiresWebView: false,
      functionName: "loadTrendingAllDay",
      cacheDuration: 3600,
      params: [
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" },
        { name: "page", title: "é¡µç ", type: "page" }
      ]
    },
    {
      title: "TMDB æœ¬å‘¨è¶‹åŠ¿",
      description: "æœ¬å‘¨å…¨éƒ¨è¶‹åŠ¿",
      requiresWebView: false,
      functionName: "loadTrendingAllWeek",
      cacheDuration: 3600,
      params: [
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" },
        { name: "page", title: "é¡µç ", type: "page" }
      ]
    },
    {
      title: "TMDB çƒ­é—¨å‰§é›†",
      description: "ä»Šæ—¥çƒ­é—¨ç”µè§†å‰§",
      requiresWebView: false,
      functionName: "loadTodayHotTV",
      cacheDuration: 3600,
      params: [
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" },
        { name: "sort_by", title: "åœ°åŒº", type: "enumeration", enumOptions: [{ title: "å…¨éƒ¨åœ°åŒº", value: "" }, { title: "ä¸­å›½", value: "CN" }, { title: "ç¾å›½", value: "US" }, { title: "éŸ©å›½", value: "KR" }, { title: "æ—¥æœ¬", value: "JP" }], value: "" },
        { name: "page", title: "é¡µç ", type: "page" }
      ]
    },
    {
      title: "TMDB çƒ­é—¨ç”µå½±",
      description: "ä»Šæ—¥çƒ­é—¨ç”µå½±",
      requiresWebView: false,
      functionName: "loadTodayHotMovies",
      cacheDuration: 3600,
      params: [
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" },
        { name: "sort_by", title: "åœ°åŒº", type: "enumeration", enumOptions: [{ title: "å…¨éƒ¨åœ°åŒº", value: "" }, { title: "ä¸­å›½", value: "CN" }, { title: "ç¾å›½", value: "US" }, { title: "éŸ©å›½", value: "KR" }, { title: "æ—¥æœ¬", value: "JP" }], value: "" },
        { name: "page", title: "é¡µç ", type: "page" }
      ]
    },
    {
      title: "TMDB é«˜åˆ†å†…å®¹",
      description: "é«˜åˆ†ç”µå½±æˆ–å‰§é›†",
      requiresWebView: false,
      functionName: "tmdbTopRated",
      cacheDuration: 3600,
      params: [
        { name: "type", title: "ğŸ­ç±»å‹", type: "enumeration", enumOptions: [{ title: "ç”µå½±", value: "movie" }, { title: "å‰§é›†", value: "tv" }], value: "movie" },
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" },
        { name: "page", title: "é¡µç ", type: "page" }
      ]
    },
    // --- æ’­å‡ºå¹³å°æ¨¡å— ---
    {
        title: "TMDB æ’­å‡ºå¹³å°",
        description: "æŒ‰æ’­å‡ºå¹³å°å’Œå†…å®¹ç±»å‹ç­›é€‰å‰§é›†å†…å®¹",
        requiresWebView: false,
        functionName: "tmdbDiscoverByNetwork",
        cacheDuration: 3600,
        params: [
            {
                name: "with_networks",
                title: "æ’­å‡ºå¹³å°",
                type: "enumeration",
                description: "é€‰æ‹©ä¸€ä¸ªå¹³å°ä»¥æŸ¥çœ‹å…¶å‰§é›†å†…å®¹",
                value: "",
                belongTo: {
                  paramName: "air_status",
                  value: ["released","upcoming",""],
                },
          enumOptions: [
            { title: "å…¨éƒ¨", value: "" },
            { title: "Tencent", value: "2007" },
            { title: "iQiyi", value: "1330" },
            { title: "Youku", value: "1419" },
            { title: "Bilibili", value: "1605" },
            { title: "MGTV", value: "1631" },
            { title: "Netflix", value: "213" },
            { title: "Disney+", value: "2739" },
            { title: "HBO", value: "49" },
            { title: "HBO Max", value: "3186" },
            { title: "Apple TV+", value: "2552" },
            { title: "Hulu", value: "453" },
            { title: "Amazon Prime Video", value: "1024" },
            { title: "FOX", value: "19" },
            { title: "Paramount+", value: "4330" },
            { title: "TV Tokyo", value: "94" },
            { title: "BBC One", value: "332" },
            { title: "BBC Two", value: "295" },
            { title: "NBC", value: "6" },
            { title: "AMC+", value: "174" },
            { title: "We TV", value: "3732" },
            { title: "Viu TV", value: "2146" },
            { title: "TVB", value: "48" }
          ]
        },
        {
          name: "with_genres",
          title: "ğŸ­å†…å®¹ç±»å‹",
          type: "enumeration",
          description: "é€‰æ‹©è¦ç­›é€‰çš„å†…å®¹ç±»å‹",
          value: "",
          belongTo: {
            paramName: "air_status",
            value: ["released","upcoming",""],
          },
          enumOptions: [
            { title: "å…¨éƒ¨ç±»å‹", value: "" },
            { title: "çŠ¯ç½ª", value: "80" },
            { title: "åŠ¨ç”»", value: "16" },
            { title: "å–œå‰§", value: "35" },
            { title: "å‰§æƒ…", value: "18" },
            { title: "å®¶åº­", value: "10751" },
            { title: "æ‚¬ç–‘", value: "9648" },
            { title: "çœŸäººç§€", value: "10764" },
            { title: "è„±å£ç§€", value: "10767" },
            { title: "çºªå½•ç‰‡", value: "99" },
            { title: "åŠ¨ä½œä¸å†’é™©", value: "10759" },
            { title: "ç§‘å¹»ä¸å¥‡å¹»", value: "10765" },
            { title: "æˆ˜äº‰ä¸æ”¿æ²»", value: "10768" }
          ]
        },
        {
          name: "air_status",
          title: "ä¸Šæ˜ çŠ¶æ€",
          type: "enumeration",
          description: "é»˜è®¤å·²ä¸Šæ˜ ",
          value: "released",
          enumOptions: [
            { title: "å·²ä¸Šæ˜ ", value: "released" },
            { title: "æœªä¸Šæ˜ ", value: "upcoming" },
            { title: "å…¨éƒ¨", value: "" }
          ]
        },
        {
          name: "sort_by",
          title: "ğŸ”¢ æ’åºæ–¹å¼",
          type: "enumeration",
          description: "é€‰æ‹©å†…å®¹æ’åºæ–¹å¼,é»˜è®¤ä¸Šæ˜ æ—¶é—´â†“",
          value: "first_air_date.desc",
          enumOptions: [
            { title: "ä¸Šæ˜ æ—¶é—´â†“", value: "first_air_date.desc" },
            { title: "ä¸Šæ˜ æ—¶é—´â†‘", value: "first_air_date.asc" },
            { title: "äººæ°”æœ€é«˜", value: "popularity.desc" },
            { title: "è¯„åˆ†æœ€é«˜", value: "vote_average.desc" },
            { title: "æœ€å¤šæŠ•ç¥¨", value: "vote_count.desc" }
          ]
        },
        { name: "page", title: "é¡µç ", type: "page" },
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" }
      ]
    },
    // --- å‡ºå“å…¬å¸æ¨¡å— ---
    {
      title: "TMDB å‡ºå“å…¬å¸",
      functionName: "tmdbCompanies",
      cacheDuration: 3600,
      params: [
        {
          name: "with_companies",
          title: "å‡ºå“å…¬å¸",
          type: "enumeration",
          value: "",
          description: "é€‰æ‹©ä¸€ä¸ªå…¬å¸ä»¥æŸ¥çœ‹å…¶å‰§é›†å†…å®¹",
          belongTo: {
            paramName: "air_status",
            value: ["released","upcoming",""],
          },
          enumOptions: [
            { title: "å…¨éƒ¨", value: "" },
            { title: "Disney", value: "2" },
            { title: "Warner Bros", value: "174" },
            { title: "Columbia", value: "5" },
            { title: "Sony", value: "34" },
            { title: "Universal", value: "33" },
            { title: "Paramount", value: "4" },
            { title: "20th Century", value: "25" },
            { title: "Marvel", value: "420" },
            { title: "Toho", value: "882" },
            { title: "ä¸­å›½ç”µå½±é›†å›¢å…¬å¸", value: "14714" },
            { title: "BBC", value: "3324" },
            { title: "A24", value: "41077" },
            { title: "Blumhouse", value: "3172" },
            { title: "Working Title Films", value: "10163" }
          ]
        },
        {
          name: "with_genres",
          title: "ğŸ­å†…å®¹ç±»å‹",
          type: "enumeration",
          description: "é€‰æ‹©è¦ç­›é€‰çš„å†…å®¹ç±»å‹",
          value: "",
          belongTo: {
            paramName: "air_status",
            value: ["released","upcoming",""],
          },
          enumOptions: [
            { title: "å…¨éƒ¨ç±»å‹", value: "" },
            { title: "å†’é™©", value: "12" },
            { title: "å‰§æƒ…", value: "18" },
            { title: "åŠ¨ä½œ", value: "28" },
            { title: "åŠ¨ç”»", value: "16" },
            { title: "å†å²", value: "36" },
            { title: "å–œå‰§", value: "35" },
            { title: "å¥‡å¹»", value: "14" },
            { title: "å®¶åº­", value: "10751" },
            { title: "ææ€–", value: "27" },
            { title: "æ‚¬ç–‘", value: "9648" },
            { title: "æƒŠæ‚š", value: "53" },
            { title: "æˆ˜äº‰", value: "10752" },
            { title: "çˆ±æƒ…", value: "10749" },
            { title: "çŠ¯ç½ª", value: "80" },
            { title: "ç§‘å¹»", value: "878" },
            { title: "è®°å½•", value: "99" },
            { title: "è¥¿éƒ¨", value: "37" },
            { title: "éŸ³ä¹", value: "10402" },
            { title: "ç”µè§†ç”µå½±", value: "10770" }
          ]
        },
        {
          name: "air_status",
          title: "ä¸Šæ˜ çŠ¶æ€",
          type: "enumeration",
          description: "é»˜è®¤å·²ä¸Šæ˜ ",
          value: "released",
          enumOptions: [
            { title: "å·²ä¸Šæ˜ ", value: "released" },
            { title: "æœªä¸Šæ˜ ", value: "upcoming" },
            { title: "å…¨éƒ¨", value: "" }
          ]
        },
        {
          name: "sort_by",
          title: "ğŸ”¢ æ’åºæ–¹å¼",
          type: "enumeration",
          description: "é€‰æ‹©å†…å®¹æ’åºæ–¹å¼,é»˜è®¤ä¸Šæ˜ æ—¶é—´â†“",
          value: "primary_release_date.desc",
          enumOptions: [
            { title: "ä¸Šæ˜ æ—¶é—´â†“", value: "primary_release_date.desc" },
            { title: "ä¸Šæ˜ æ—¶é—´â†‘", value: "primary_release_date.asc" },
            { title: "äººæ°”æœ€é«˜", value: "popularity.desc" },
            { title: "è¯„åˆ†æœ€é«˜", value: "vote_average.desc" },
            { title: "æœ€å¤šæŠ•ç¥¨", value: "vote_count.desc" }
          ]
        },
        { name: "page", title: "é¡µç ", type: "page" },
        { name: "language", title: "è¯­è¨€", type: "language", value: "zh-CN" }
      ]
    },
      title: "TMDB æœç´¢å±è”½",
      description: "æŒ‰åç§°/ç±»å‹å±è”½",
      requiresWebView: false,
      functionName: "searchAndBlock",
      cacheDuration: 0,
      params: [
        { name: "block_type", title: "å±è”½ç±»å‹", type: "enumeration", enumOptions: [{ title: "æŒ‰åç§°", value: "by_name" }, { title: "æŒ‰ç±»å‹", value: "by_genre" }, { title: "æ‰‹åŠ¨ID", value: "manual_id" }], value: "by_name" },
        { name: "action", title: "æ“ä½œ", type: "enumeration", enumOptions: [{ title: "ä»…æœç´¢", value: "search_only" }, { title: "æœç´¢å¹¶å±è”½", value: "search_and_block" }], value: "search_only" },
        { name: "query", title: "å½±ç‰‡å", type: "input", value: "", placeholder: "é¬¼ç­ä¹‹åˆƒ" },
        { name: "genre_name", title: "ç±»å‹å", type: "input", value: "", placeholder: "çœŸäººç§€" },
        { name: "language", title: "è¯­è¨€", type: "enumeration", enumOptions: [{ title: "ä¸­æ–‡", value: "zh-CN" }, { title: "è‹±æ–‡", value: "en-US" }], value: "zh-CN" },
        { name: "tmdb_id", title: "TMDB ID", type: "input", value: "", placeholder: "550" },
        { name: "media_type", title: "åª’ä½“ç±»å‹", type: "enumeration", enumOptions: [{ title: "å‰§é›†", value: "tv" }, { title: "ç”µå½±", value: "movie" }], value: "tv" }
      ]
    },
    {
      title: "TMDB å±è”½ç®¡ç†",
      description: "æŸ¥çœ‹/ç®¡ç†å±è”½åˆ—è¡¨",
      requiresWebView: false,
      functionName: "manageBlockedItems",
      cacheDuration: 0,
      params: [
        { name: "manage_type", title: "ç®¡ç†ç±»å‹", type: "enumeration", enumOptions: [{ title: "å±è”½å†…å®¹", value: "items" }, { title: "å±è”½ç±»å‹", value: "genres" }], value: "items" },
        { name: "action", title: "æ“ä½œ", type: "enumeration", enumOptions: [{ title: "æŸ¥çœ‹", value: "view" }, { title: "æ¸…ç©º", value: "clear" }, { title: "å–æ¶ˆå±è”½", value: "unblock" }, { title: "å¯¼å‡º", value: "export" }, { title: "å¯¼å…¥", value: "import" }], value: "view" },
        { name: "unblock_id", title: "å–æ¶ˆID", type: "input", value: "", placeholder: "2190", belongTo: { paramName: "action", value: ["unblock"] } },
        { name: "unblock_media_type", title: "åª’ä½“ç±»å‹", type: "enumeration", enumOptions: [{ title: "å‰§é›†", value: "tv" }, { title: "ç”µå½±", value: "movie" }], value: "tv", belongTo: { paramName: "action", value: ["unblock"], paramName2: "manage_type", value2: ["items"] } },
        { name: "import_data", title: "å¯¼å…¥æ•°æ®", type: "input", value: "", placeholder: "550,1399", belongTo: { paramName: "action", value: ["import"] } }
      ]
    }
  ]
};

// å±è”½é…ç½®
const GENRE_STORAGE_KEY = "forward_blocked_genres";
const STORAGE_KEY = "forward_blocked_items";
const TMDB_GENRE_MAPPING = { "çœŸäººç§€":10767,"åŠ¨ç”»":16,"å–œå‰§":35,"å‰§æƒ…":18,"çŠ¯ç½ª":80,"ç§‘å¹»":10765,"ææ€–":9648,"çºªå½•ç‰‡":99 };
const REVERSE_GENRE_MAPPING = Object.fromEntries(Object.entries(TMDB_GENRE_MAPPING).map(([k,v])=>[v,k]));
let blockedIdCache=null, blockedGenresCache=null, blockedItemsCache=null, tmdbGenresCache=null;

function clearAllCaches(){blockedIdCache=null; blockedGenresCache=null; blockedItemsCache=null; tmdbGenresCache=null;}
function clearBlockedIdCache(){blockedIdCache=null;}
function clearBlockedGenresCache(){blockedGenresCache=null;}
function clearBlockedItemsCache(){blockedItemsCache=null;}

function getBlockedIdSet(){
  try{
    if(blockedIdCache) return blockedIdCache;
    const items=getBlockedItems();
    const s=new Set();
    items.forEach(i=>{const id=String(i.id); const nid=parseInt(i.id); s.add(id+"_"+i.media_type); s.add(nid+"_"+i.media_type); s.add(id); s.add(nid);});
    blockedIdCache=s;
    return s;
  }catch{return new Set();}
}

function getBlockedGenres(){try{if(blockedGenresCache)return blockedGenresCache; const s=Widget.storage.get(GENRE_STORAGE_KEY); blockedGenresCache=s?JSON.parse(s):[]; return blockedGenresCache;}catch{return[];}}
function saveBlockedGenres(g){try{Widget.storage.set(GENRE_STORAGE_KEY,JSON.stringify(g)); blockedGenresCache=g; clearBlockedIdCache(); return true;}catch{return false;}}
function getBlockedItems(){try{if(blockedItemsCache)return blockedItemsCache; const s=Widget.storage.get(STORAGE_KEY); blockedItemsCache=s?JSON.parse(s):[]; return blockedItemsCache;}catch{return[];}}
function saveBlockedItems(i){try{Widget.storage.set(STORAGE_KEY,JSON.stringify(i)); blockedItemsCache=i; clearBlockedIdCache(); return true;}catch{return false;}}

function isItemBlocked(item){
  if(!item?.id)return false;
  const s=getBlockedIdSet();
  const id=String(item.id); const nid=parseInt(item.id);
  if(s.has(id)||s.has(nid))return true;
  const mt=item.mediaType||item.media_type;
  if(mt&&(s.has(id+"_"+mt)||s.has(nid+"_"+mt)))return true;
  return false;
}

function isItemBlockedByGenre(item){
  if(!item?.genre_ids)return false;
  const bg=getBlockedGenres();
  const s=new Set(bg.map(g=>g.id));
  return item.genre_ids.some(id=>s.has(id));
}

function isItemBlockedEnhanced(item){return isItemBlocked(item)||isItemBlockedByGenre(item);}
function filterBlockedItemsEnhanced(items){if(!Array.isArray(items))return items; const s=getBlockedIdSet(); const bg=getBlockedGenres(); const gs=new Set(bg.map(g=>g.id)); return items.filter(i=>{if(!i?.id)return true; const id=String(i.id); const nid=parseInt(i.id); if(s.has(id)||s.has(nid))return false; if(i.genre_ids?.some(g=>gs.has(g)))return false; const mt=i.mediaType||i.media_type; if(mt&&(s.has(id+"_"+mt)||s.has(nid+"_"+mt)))return false; return true;});}

function addBlockedGenre(name,id,desc=""){const list=getBlockedGenres(); if(list.some(g=>g.id===id||g.name===name))return false; list.push({id,name,description:desc||`å±è”½${name}`,blocked_date:new Date().toISOString()}); return saveBlockedGenres(list);}
function removeBlockedGenre(id){const list=getBlockedGenres().filter(g=>g.id!==id); return saveBlockedGenres(list);}
function addBlockedItem(item){const list=getBlockedItems(); if(list.some(b=>b.id===String(item.id)&&b.media_type===item.media_type))return false; list.push({id:String(item.id),media_type:item.media_type,title:item.title,poster_path:item.poster_path,overview:item.overview,blocked_date:new Date().toISOString(),vote_average:item.vote_average||0}); return saveBlockedItems(list);}
function removeBlockedItem(id,mt){const list=getBlockedItems().filter(i=>!(i.id===String(id)&&i.media_type===mt)); return saveBlockedItems(list);}
function clearBlockedItems(){try{Widget.storage.clear(); clearAllCaches(); return true;}catch{return false;}}

// è¾…åŠ©å‡½æ•°
async function fetchTmdbGenres(){if(tmdbGenresCache)return tmdbGenresCache; const [mg,tg]=await Promise.all([Widget.tmdb.get('/genre/movie/list',{params:{language:'zh-CN'}}),Widget.tmdb.get('/genre/tv/list',{params:{language:'zh-CN'}})]); tmdbGenresCache={movie:mg.genres.reduce((a,c)=>({...a,[c.id]:c.name}),{}),tv:tg.genres.reduce((a,c)=>({...a,[c.id]:c.name}),{})}; return tmdbGenresCache;}
function getTmdbGenreTitles(ids,mt){const map=tmdbGenresCache?.[mt]||{}; return ids.slice(0,3).map(id=>map[id]||`æœªçŸ¥(${id})`).filter(Boolean).join('â€¢');}
function extractGenresFromText(t){if(!t)return[]; const kw=["åŠ¨ä½œ","ç§‘å¹»","ç¾éš¾","çˆ±æƒ…","å–œå‰§","æ‚¬ç–‘","çŠ¯ç½ª","å†’é™©","å¥‡å¹»","æˆ˜äº‰","å†å²","æ­¦ä¾ ","æƒŠæ‚š","ææ€–","åŠ¨ç”»","å‰§æƒ…","è¥¿éƒ¨","å®¶åº­","éŸ³ä¹","è¿åŠ¨","å¤è£…","æ­Œèˆ","ä¼ è®°","çŸ­ç‰‡","çºªå½•ç‰‡","æ–‡è‰º","é’æ˜¥","æ ¡å›­","èŒåœº","éƒ½å¸‚","å†œæ‘","å†›äº‹","è­¦æ¢","è°æˆ˜","å®«å»·","ç¥è¯","é­”å¹»"]; const set=new Set(); kw.forEach(k=>t.includes(k)&&set.add(k)); return Array.from(set).slice(0,3);}
function formatItemDescription(item){let d=item.description||""; if(item.itemType&&!/ç±»å‹|type/i.test(d))d=`ç±»å‹: ${item.itemType} | `+d; if(item.rating&&!/è¯„åˆ†|rating/i.test(d))d=`è¯„åˆ†: ${item.rating} | `+d; if(item.releaseDate){const y=String(item.releaseDate).slice(0,4); if(/^\d{4}$/.test(y)&&!/å¹´ä»½|year/i.test(d))d=`å¹´ä»½: ${y} | `+d;} return d.replace(/^\|*\s*|\s*\|*$/g,"");}
function calculatePagination(p){const page=Math.max(1,parseInt(p.page)||1); const limit=parseInt(p.limit)||20; const start=(page-1)*limit; return {page,limit,start};}
function getBeijingDate(){const d=new Date(); const utc=d.getTime()+d.getTimezoneOffset()*60000; const bj=new Date(utc+8*3600000); const y=bj.getFullYear(); const m=String(bj.getMonth()+1).padStart(2,'0'); const day=String(bj.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`;}

// TMDB è¯·æ±‚
const MIN_VOTE_COUNT={movie:50,tv:30};
const POPULARITY_QUALITY_STANDARDS={movie:{minVoteCount:10,minVoteAverage:3.0},tv:{minVoteCount:1,minVoteAverage:3.0}};
const DOMESTIC_PLATFORMS=['2007','1330','1419','1605','1631'];
const DOMESTIC_MIN_VOTE_COUNT={tv:5};
const DOMESTIC_PLATFORM_STANDARDS={movie:{minVoteCount:5,minVoteAverage:3.0},tv:{minVoteCount:1,minVoteAverage:3.0}};

async function fetchTmdbData(api,p){const [data,genres]=await Promise.all([Widget.tmdb.get(api,{params:p}),fetchTmdbGenres()]); const res=data.results.filter(it=>{const mt=it.media_type||(it.title?"movie":"tv"); const ok=it.poster_path&&it.id&&(it.title||it.name)?.trim()&&it.genre_ids?.length; if(!ok)return false; if(p.sort_by==="vote_average.desc"){const dom=DOMESTIC_PLATFORMS.includes(String(p.with_networks)); const min=dom?DOMESTIC_MIN_VOTE_COUNT[mt]:MIN_VOTE_COUNT[mt]; return it.vote_count>=min;} return true;}).map(it=>{const mt=it.media_type||(it.title?"movie":"tv"); return{id:it.id,type:"tmdb",title:it.title||it.name,description:it.overview,releaseDate:it.release_date||it.first_air_date,backdropPath:it.backdrop_path,posterPath:it.poster_path,rating:it.vote_average,mediaType:mt,genreTitle:getTmdbGenreTitles(it.genre_ids,mt),genre_ids:it.genre_ids};}); return filterBlockedItemsEnhanced(res);}

// çƒ­é—¨å‰§é›† & ç”µå½±
async function loadTodayHotTV(p) {
  const page = parseInt(p.page) || 1;
  const region = p.sort_by || "";
  const lang = p.language || "zh-CN";
  
  if (region) {
    const dom = region === "CN";
    const std = dom ? DOMESTIC_PLATFORM_STANDARDS.tv : POPULARITY_QUALITY_STANDARDS.tv;
    return fetchTmdbData("/discover/tv", {
      language: lang,
      page: page,
      region: region,
      sort_by: "popularity.desc",
      "vote_count.gte": std.minVoteCount,
      "vote_average.gte": std.minVoteAverage
    });
  }
  
  return fetchTmdbData("/trending/tv/day", { language: lang, page: page });
}

async function loadTodayHotMovies(p) {
  const page = parseInt(p.page) || 1;
  const region = p.sort_by || "";
  const lang = p.language || "zh-CN";
  
  if (region) {
    const dom = region === "CN";
    const std = dom ? DOMESTIC_PLATFORM_STANDARDS.movie : POPULARITY_QUALITY_STANDARDS.movie;
    return fetchTmdbData("/discover/movie", {
      language: lang,
      page: page,
      region: region,
      sort_by: "popularity.desc",
      "vote_count.gte": std.minVoteCount,
      "vote_average.gte": std.minVoteAverage
    });
  }
  
  return fetchTmdbData("/trending/movie/day", { language: lang, page: page });
}

// ä»Šæ—¥è¶‹åŠ¿ + æœ¬å‘¨è¶‹åŠ¿
async function loadTrendingAllDay(p) {
  const page = parseInt(p.page) || 1;
  const lang = p.language || "zh-CN";
  return fetchTmdbData("/trending/all/day", { language: lang, page: page });
}
async function loadTrendingAllWeek(p) {
  const page = parseInt(p.page) || 1;
  const lang = p.language || "zh-CN";
  return fetchTmdbData("/trending/all/week", { language: lang, page: page });
}

async function tmdbTopRated(p){const t=p.type||"movie"; return fetchTmdbData(`/${t}/top_rated`,{language:p.language||"zh-CN",page:p.page||1});}
async function tmdbDiscoverByNetwork(p={}){const today=getBeijingDate(); const q={language:p.language||"zh-CN",page:p.page||1,with_networks:p.with_networks,with_genres:p.with_genres,sort_by:p.sort_by||"first_air_date.desc"}; if(q.sort_by==="vote_average.desc"){const dom=DOMESTIC_PLATFORMS.includes(String(p.with_networks)); q["vote_count.gte"]=dom?DOMESTIC_MIN_VOTE_COUNT.tv:MIN_VOTE_COUNT.tv;} if(p.air_status==="released")q["first_air_date.lte"]=today; else if(p.air_status==="upcoming")q["first_air_date.gte"]=today; return fetchTmdbData("/discover/tv",q);}
async function tmdbCompanies(p={}){const today=getBeijingDate(); const q={language:p.language||"zh-CN",page:p.page||1,with_companies:p.with_companies,sort_by:p.sort_by||"primary_release_date.desc",include_adult:false,include_video:false}; if(q.sort_by==="vote_average.desc")q["vote_count.gte"]=MIN_VOTE_COUNT.movie; if(q.sort_by==="popularity.desc"){q["vote_count.gte"]=POPULARITY_QUALITY_STANDARDS.movie.minVoteCount; q["vote_average.gte"]=POPULARITY_QUALITY_STANDARDS.movie.minVoteAverage;} if(q.sort_by==="vote_average.desc")q["vote_average.gte"]=6.0; if(p.air_status==="released")q["primary_release_date.lte"]=today; else if(p.air_status==="upcoming")q["primary_release_date.gte"]=today; return fetchTmdbData("/discover/movie",q);}

// å±è”½æœç´¢/ç®¡ç†
async function searchAndBlock(p){const bt=p.block_type||"by_name"; const act=p.action||"search_only"; if(bt==="by_genre"){const name=(p.genre_name||"").trim(); const id=TMDB_GENRE_MAPPING[name]; if(!id)return[{id:"g_err",type:"info",title:"âš ï¸ ä¸æ”¯æŒçš„ç±»å‹",description:`å¯å±è”½ï¼š${Object.keys(TMDB_GENRE_MAPPING).join('ã€')}`}]; const ok=addBlockedGenre(name,id); return[{id:"g_ok",type:"info",title:ok?"âœ… å·²å±è”½ç±»å‹":"â„¹ï¸ å·²å­˜åœ¨",description:`å±è”½ã€${name}ã€‘`}];} if(bt==="manual_id"){const id=p.tmdb_id?.trim(); const mt=p.media_type||"tv"; if(!id||!/^\d+$/.test(id))return[{id:"m_err",type:"info",title:"âš ï¸ ID æ ¼å¼é”™è¯¯"}]; const fake={id,media_type:mt,title:`TMDB ${mt} ${id}`}; const ok=addBlockedItem(fake); return[{id:"m_ok",type:"info",title:ok?"âœ… å·²å±è”½":"â„¹ï¸ å·²å­˜åœ¨",description:fake.title}];} const q=(p.query||"").trim(); const lang=p.language||"zh-CN"; if(!q)return[{id:"s_empty",type:"info",title:"ğŸ” è¯·è¾“å…¥å½±ç‰‡å"}]; const [movieRes,tvRes]=await Promise.all([Widget.tmdb.get("/search/movie",{params:{query:q,language:lang}}),Widget.tmdb.get("/search/tv",{params:{query:q,language:lang}})]); const list=[...(movieRes.results||[]).map(i=>({...i,media_type:"movie"})),...(tvRes.results||[]).map(i=>({...i,media_type:"tv"}))].filter(i=>i.poster_path&&i.id&&(i.title||i.name)).slice(0,15); if(act==="search_only")return list.map(i=>({id:i.id,type:"tmdb",title:i.title||i.name,description:i.overview,posterPath:i.poster_path,mediaType:i.media_type,link:`block://${i.id}/${i.media_type}/${encodeURIComponent(i.title||i.name)}`})); const added=[]; for(const i of list.slice(0,5))if(addBlockedItem(i))added.push(i.title||i.name); return[{id:"b_res",type:"info",title:"âœ… æ‰¹é‡å±è”½å®Œæˆ",description:`å·²å±è”½ï¼š${added.join('ã€')||'æ— æ–°é¡¹ç›®'}`}];}
async function manageBlockedItems(p){const mt=p.manage_type||"items"; const act=p.action||"view"; if(act==="clear"){const ok=clearBlockedItems(); return[{id:"clr",type:"info",title:ok?"âœ… å·²æ¸…ç©º":"âŒ å¤±è´¥",description:ok?"æ‰€æœ‰å±è”½å·²æ¸…é™¤":"æ“ä½œå¼‚å¸¸"}];} if(act==="unblock"){const id=p.unblock_id?.trim(); const umt=p.unblock_media_type||"tv"; if(!id)return[{id:"ub_err",type:"info",title:"âš ï¸ è¯·è¾“å…¥ID"}]; const ok=mt==="items"?removeBlockedItem(id,umt):removeBlockedGenre(parseInt(id)); return[{id:"ub_ok",type:"info",title:ok?"âœ… å·²å–æ¶ˆ":"âŒ å¤±è´¥",description:`IDï¼š${id}`}];} if(act==="export"){const items=getBlockedItems(); const ids=items.map(i=>i.id).join(','); return[{id:"exp",type:"info",title:"ğŸ“¤ å¯¼å‡ºå±è”½åˆ—è¡¨",description:`å…± ${items.length} ä¸ªï¼š\n${ids||'ç©º'}`}];} if(act==="import"){const data=(p.import_data||"").trim().replace(/['"]/g,''); if(!data)return[{id:"imp_empty",type:"info",title:"âš ï¸ è¯·è¾“å…¥æ•°æ®"}]; const ids=data.split(',').map(s=>s.trim()).filter(s=>/^\d+$/.test(s)); const items=getBlockedItems(); let c=0; for(const id of ids){const exist=items.some(i=>i.id===id); if(!exist){items.push({id,media_type:"movie",title:`ID ${id}`,poster_path:"",overview:"å¯¼å…¥",blocked_date:new Date().toISOString()}); c++;}} saveBlockedItems(items); return[{id:"imp_ok",type:"info",title:"âœ… å¯¼å…¥å®Œæˆ",description:`æ–°å¢ ${c} ä¸ªï¼Œæ€»è®¡ ${items.length}`}];} if(mt==="genres"){const list=getBlockedGenres(); if(!list.length)return[{id:"g_empty",type:"info",title:"â„¹ï¸ æ— å±è”½ç±»å‹"}]; return list.map(g=>({id:`g_${g.id}`,type:"info",title:`ğŸš« ${g.name}`,description:g.description||`IDï¼š${g.id}`}));} const items=getBlockedItems(); if(!items.length)return[{id:"b_empty",type:"info",title:"â„¹ï¸ å±è”½åˆ—è¡¨ä¸ºç©º"}]; const sorted=[...items].sort((a,b)=>new Date(b.blocked_date)-new Date(a.blocked_date)); return[{id:"tip",type:"info",title:"ğŸ’¡ å–æ¶ˆå±è”½è¯´æ˜",description:"è®°å½•ID â†’ æ“ä½œé€‰ã€å–æ¶ˆå±è”½ã€‘â†’ å¡«å…¥ID"},...sorted.map(i=>({id:`b_${i.id}_${i.media_type}`,type:"info",title:`ğŸš« ${i.title}`,description:`${i.media_type==="movie"?"ç”µå½±":"å‰§é›†"} | IDï¼š${i.id} | ${i.blocked_date.slice(0,10)}`,posterPath:i.poster_path?`https://image.tmdb.org/t/p/w500${i.poster_path}`:"",mediaType:i.media_type,link:`unblock://${i.id}/${i.media_type}/${encodeURIComponent(i.title)}`}))];}

// è¯¦æƒ…å‡½æ•°
async function loadDetail(link){try{if(link.startsWith("block://")){const parts=link.replace("block://","").split("/"); const [id,mediaType,encodedTitle]=parts; const title=decodeURIComponent(encodedTitle); const endpoint=mediaType==="movie"?`/movie/${id}`:`/tv/${id}`; const res=await Widget.tmdb.get(endpoint,{params:{language:"zh-CN"}}); const item=res.data||res; const ok=addBlockedItem({id,media_type:mediaType,title:item.title||item.name,poster_path:item.poster_path,overview:item.overview,vote_average:item.vote_average}); return{videoUrl:"",title:ok?"âœ… å±è”½æˆåŠŸ":"â„¹ï¸ å·²å­˜åœ¨",description:`${mediaType==="movie"?"ç”µå½±":"å‰§é›†"}ã€Œ${title}ã€å·²åŠ å…¥å±è”½`};} if(link.startsWith("unblock://")){const parts=link.replace("unblock://","").split("/"); const [id,mediaType,encodedTitle]=parts; const ok=removeBlockedItem(id,mediaType); return{videoUrl:"",title:ok?"âœ… å–æ¶ˆå±è”½æˆåŠŸ":"âŒ å¤±è´¥",description:`ID ${id} å·²ä»å±è”½åˆ—è¡¨ç§»é™¤`};} return{videoUrl:"",title:"âŒ æ— æ•ˆé“¾æ¥",description:"æ— æ³•è¯†åˆ«æ“ä½œ"};}catch(e){return{videoUrl:"",title:"âŒ æ“ä½œå¤±è´¥",description:e.message};}}
